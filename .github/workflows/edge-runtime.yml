name: Build Edge Runtime

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Edge runtime version (e.g., v1.67.4)'
        required: true
        default: 'v1.67.4'

permissions:
  contents: write

jobs:
  # Extract Linux binaries from official Supabase Docker images
  extract-linux:
    name: Extract Linux ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
          - arch: arm64
            platform: linux/arm64

    steps:
      - name: Set up QEMU (for arm64 extraction)
        uses: docker/setup-qemu-action@v3

      - name: Extract binary from Docker image
        run: |
          # Pull the official Supabase edge-runtime image for the target platform
          docker pull --platform ${{ matrix.platform }} ghcr.io/supabase/edge-runtime:${{ inputs.version }}

          # Create a container (don't run it)
          CONTAINER_ID=$(docker create --platform ${{ matrix.platform }} ghcr.io/supabase/edge-runtime:${{ inputs.version }})

          # Extract the edge-runtime binary
          mkdir -p dist
          docker cp "$CONTAINER_ID:/usr/local/bin/edge-runtime" "dist/edge-runtime-${{ inputs.version }}-linux-${{ matrix.arch }}"

          # Clean up
          docker rm "$CONTAINER_ID"

          # Make executable and show info
          chmod +x "dist/edge-runtime-${{ inputs.version }}-linux-${{ matrix.arch }}"
          ls -la dist/
          file "dist/edge-runtime-${{ inputs.version }}-linux-${{ matrix.arch }}"

      - name: Verify binary dependencies
        run: |
          BINARY="dist/edge-runtime-${{ inputs.version }}-linux-${{ matrix.arch }}"
          echo "Checking dynamic dependencies..."
          # Use the same platform container to check dependencies
          docker run --rm --platform ${{ matrix.platform }} \
            -v "$(pwd)/dist:/dist" \
            ghcr.io/supabase/edge-runtime:${{ inputs.version }} \
            ldd "/dist/edge-runtime-${{ inputs.version }}-linux-${{ matrix.arch }}" || true

      - name: Create tarball
        run: |
          cd dist
          TARBALL="edge-runtime-${{ inputs.version }}-linux-${{ matrix.arch }}.tar.gz"
          tar -czf "$TARBALL" "edge-runtime-${{ inputs.version }}-linux-${{ matrix.arch }}"
          rm "edge-runtime-${{ inputs.version }}-linux-${{ matrix.arch }}"
          ls -la "$TARBALL"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: edge-runtime-linux-${{ matrix.arch }}
          path: dist/edge-runtime-${{ inputs.version }}-linux-${{ matrix.arch }}.tar.gz

  # Build macOS binaries natively with bundled dylibs for portability
  build-macos:
    name: Build macOS ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          # macOS ARM64 (Apple Silicon)
          - arch: arm64
            runner: macos-latest
            target: aarch64-apple-darwin
            homebrew_prefix: /opt/homebrew
          # macOS AMD64 (Intel)
          - arch: amd64
            runner: macos-15-large
            target: x86_64-apple-darwin
            homebrew_prefix: /usr/local

    steps:
      - name: Checkout edge-runtime
        uses: actions/checkout@v4
        with:
          repository: supabase/edge-runtime
          ref: ${{ inputs.version }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install macOS dependencies
        run: |
          brew install openblas libomp

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: darwin-${{ matrix.arch }}

      - name: Build edge-runtime
        run: |
          cargo build --release --target ${{ matrix.target }}

      - name: Prepare binary
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/edge-runtime dist/edge-runtime-${{ inputs.version }}-darwin-${{ matrix.arch }}
          chmod +x dist/edge-runtime-${{ inputs.version }}-darwin-${{ matrix.arch }}

      - name: Strip binary (reduce size)
        run: |
          echo "Before strip: $(du -h dist/edge-runtime-${{ inputs.version }}-darwin-${{ matrix.arch }})"
          strip dist/edge-runtime-${{ inputs.version }}-darwin-${{ matrix.arch }}
          echo "After strip: $(du -h dist/edge-runtime-${{ inputs.version }}-darwin-${{ matrix.arch }})"

      - name: Bundle dylibs for portability
        run: |
          BINARY="dist/edge-runtime-${{ inputs.version }}-darwin-${{ matrix.arch }}"
          LIBS_DIR="dist/libs"
          mkdir -p "$LIBS_DIR"

          echo "=== Original dependencies ==="
          otool -L "$BINARY"

          # Find all Homebrew dependencies
          HOMEBREW_DEPS=$(otool -L "$BINARY" | grep -E '${{ matrix.homebrew_prefix }}' | awk '{print $1}' || true)

          if [ -z "$HOMEBREW_DEPS" ]; then
            echo "No Homebrew dependencies found - binary is already portable"
            exit 0
          fi

          echo "=== Bundling Homebrew dependencies ==="
          echo "$HOMEBREW_DEPS"

          # Process each dependency
          for dep in $HOMEBREW_DEPS; do
            if [ -f "$dep" ]; then
              DYLIB_NAME=$(basename "$dep")
              echo "Bundling: $dep -> $LIBS_DIR/$DYLIB_NAME"

              # Copy the dylib
              cp "$dep" "$LIBS_DIR/$DYLIB_NAME"

              # Update the binary to use @loader_path
              install_name_tool -change "$dep" "@loader_path/libs/$DYLIB_NAME" "$BINARY"
            fi
          done

          # Process transitive dependencies in bundled dylibs
          # Run multiple passes until no new deps are found
          echo "=== Processing transitive dependencies ==="
          PASS=1
          while true; do
            echo "--- Pass $PASS ---"
            NEW_DEPS_FOUND=false

            for lib in "$LIBS_DIR"/*.dylib; do
              if [ -f "$lib" ]; then
                LIB_NAME=$(basename "$lib")

                # Fix the library's own ID (relative to itself, no libs/ prefix)
                install_name_tool -id "@loader_path/$LIB_NAME" "$lib" 2>/dev/null || true

                # Find Homebrew dependencies
                LIB_DEPS=$(otool -L "$lib" | grep -E '${{ matrix.homebrew_prefix }}' | awk '{print $1}' || true)
                for dep in $LIB_DEPS; do
                  if [ -f "$dep" ]; then
                    DEP_NAME=$(basename "$dep")
                    # Copy if not already bundled
                    if [ ! -f "$LIBS_DIR/$DEP_NAME" ]; then
                      echo "  Bundling transitive: $dep"
                      cp "$dep" "$LIBS_DIR/$DEP_NAME"
                      NEW_DEPS_FOUND=true
                    fi
                    # Update reference (dylib to dylib, same folder, no libs/ prefix)
                    install_name_tool -change "$dep" "@loader_path/$DEP_NAME" "$lib"
                  fi
                done
              fi
            done

            if [ "$NEW_DEPS_FOUND" = false ]; then
              echo "No new dependencies found, done."
              break
            fi

            PASS=$((PASS + 1))
            if [ $PASS -gt 10 ]; then
              echo "Warning: Too many passes, breaking"
              break
            fi
          done

          # Sign the modified binary and dylibs (required on macOS)
          echo "=== Code signing ==="
          codesign --force --sign - "$BINARY"
          for lib in "$LIBS_DIR"/*.dylib; do
            if [ -f "$lib" ]; then
              codesign --force --sign - "$lib"
            fi
          done

          echo "=== Final dependencies ==="
          otool -L "$BINARY"

          echo "=== Bundled libraries ==="
          ls -la "$LIBS_DIR"

      - name: Create tarball with bundled libs
        run: |
          cd dist
          TARBALL="edge-runtime-${{ inputs.version }}-darwin-${{ matrix.arch }}.tar.gz"
          if [ -d "libs" ] && [ "$(ls -A libs 2>/dev/null)" ]; then
            # Bundle binary + libs
            tar -czf "$TARBALL" \
              "edge-runtime-${{ inputs.version }}-darwin-${{ matrix.arch }}" \
              libs/
            echo "Created tarball with bundled libraries"
          else
            # Just the binary
            tar -czf "$TARBALL" \
              "edge-runtime-${{ inputs.version }}-darwin-${{ matrix.arch }}"
            echo "Created tarball with binary only"
          fi
          ls -la "$TARBALL"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: edge-runtime-darwin-${{ matrix.arch }}
          path: dist/edge-runtime-${{ inputs.version }}-darwin-${{ matrix.arch }}.tar.gz

  # Create release with all platform binaries
  release:
    name: Create Release
    needs: [extract-linux, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          find artifacts -type f -name 'edge-runtime-*' -exec mv {} release/ \;
          ls -la release/

      - name: Generate checksums
        working-directory: release
        run: |
          sha256sum edge-runtime-* > checksums.txt
          cat checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: edge-runtime-${{ inputs.version }}
          name: Edge Runtime ${{ inputs.version }}
          draft: false
          prerelease: false
          body: |
            Pre-built edge-runtime binaries for sblite.

            Based on [supabase/edge-runtime](https://github.com/supabase/edge-runtime) ${{ inputs.version }}.

            ## Platforms
            All binaries distributed as `.tar.gz` for consistency and smaller downloads.

            - `darwin-arm64.tar.gz` - macOS Apple Silicon (with bundled dylibs)
            - `darwin-amd64.tar.gz` - macOS Intel (with bundled dylibs)
            - `linux-arm64.tar.gz` - Linux ARM64 (from official Docker image)
            - `linux-amd64.tar.gz` - Linux x86_64 (from official Docker image)

            ## Installation

            ```bash
            # Extract
            tar -xzf edge-runtime-${{ inputs.version }}-<platform>.tar.gz

            # Run
            ./edge-runtime-${{ inputs.version }}-<platform> --help
            ```
            Note: On macOS, keep the `libs/` folder in the same directory as the binary.

            ## Verification
            ```bash
            sha256sum -c checksums.txt
            ```

            ## Source
            - Linux: Extracted from `ghcr.io/supabase/edge-runtime:${{ inputs.version }}`
            - macOS: Built from source with bundled openblas/libomp dylibs
          files: |
            release/edge-runtime-*
            release/checksums.txt
