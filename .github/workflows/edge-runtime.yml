name: Build Edge Runtime

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Edge runtime version (e.g., v1.67.4)'
        required: true
        default: 'v1.67.4'

permissions:
  contents: write

jobs:
  # Extract Linux binaries from official Supabase Docker images
  extract-linux:
    name: Extract Linux ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
          - arch: arm64
            platform: linux/arm64

    steps:
      - name: Set up QEMU (for arm64 extraction)
        uses: docker/setup-qemu-action@v3

      - name: Extract binary from Docker image
        run: |
          # Pull the official Supabase edge-runtime image for the target platform
          docker pull --platform ${{ matrix.platform }} ghcr.io/supabase/edge-runtime:${{ inputs.version }}

          # Create a container (don't run it)
          CONTAINER_ID=$(docker create --platform ${{ matrix.platform }} ghcr.io/supabase/edge-runtime:${{ inputs.version }})

          # Extract the edge-runtime binary
          mkdir -p dist
          docker cp "$CONTAINER_ID:/usr/local/bin/edge-runtime" "dist/edge-runtime-${{ inputs.version }}-linux-${{ matrix.arch }}"

          # Clean up
          docker rm "$CONTAINER_ID"

          # Make executable and show info
          chmod +x "dist/edge-runtime-${{ inputs.version }}-linux-${{ matrix.arch }}"
          ls -la dist/
          file "dist/edge-runtime-${{ inputs.version }}-linux-${{ matrix.arch }}"

      - name: Verify binary dependencies
        run: |
          BINARY="dist/edge-runtime-${{ inputs.version }}-linux-${{ matrix.arch }}"
          echo "Checking dynamic dependencies..."
          # Use the same platform container to check dependencies
          docker run --rm --platform ${{ matrix.platform }} \
            -v "$(pwd)/dist:/dist" \
            ghcr.io/supabase/edge-runtime:${{ inputs.version }} \
            ldd "/dist/edge-runtime-${{ inputs.version }}-linux-${{ matrix.arch }}" || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: edge-runtime-linux-${{ matrix.arch }}
          path: dist/edge-runtime-${{ inputs.version }}-linux-${{ matrix.arch }}

  # Build macOS binaries natively (no Docker available for macOS)
  build-macos:
    name: Build macOS ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          # macOS ARM64 (Apple Silicon)
          - arch: arm64
            runner: macos-latest
            target: aarch64-apple-darwin
          # macOS AMD64 (Intel)
          - arch: amd64
            runner: macos-15-large
            target: x86_64-apple-darwin

    steps:
      - name: Checkout edge-runtime
        uses: actions/checkout@v4
        with:
          repository: supabase/edge-runtime
          ref: ${{ inputs.version }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install macOS dependencies
        run: |
          # Note: We intentionally do NOT install openblas/libomp via Homebrew
          # to ensure the binary doesn't dynamically link against them.
          # The build should use system Accelerate framework instead.
          echo "Building without Homebrew openblas to ensure portable binary"

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: darwin-${{ matrix.arch }}

      - name: Build edge-runtime
        run: |
          cargo build --release --target ${{ matrix.target }}

      - name: Prepare binary
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/edge-runtime dist/edge-runtime-${{ inputs.version }}-darwin-${{ matrix.arch }}
          chmod +x dist/edge-runtime-${{ inputs.version }}-darwin-${{ matrix.arch }}

      - name: Strip binary (reduce size)
        run: |
          echo "Before strip: $(du -h dist/edge-runtime-${{ inputs.version }}-darwin-${{ matrix.arch }})"
          strip dist/edge-runtime-${{ inputs.version }}-darwin-${{ matrix.arch }}
          echo "After strip: $(du -h dist/edge-runtime-${{ inputs.version }}-darwin-${{ matrix.arch }})"

      - name: Verify macOS dependencies are portable
        run: |
          BINARY="dist/edge-runtime-${{ inputs.version }}-darwin-${{ matrix.arch }}"
          echo "Checking dynamic dependencies..."
          otool -L "$BINARY"

          # Check for any Homebrew dependencies - these would break portability
          if otool -L "$BINARY" | grep -qE '/opt/homebrew|/usr/local/opt'; then
            echo "::error::Binary has Homebrew dependencies that will break portability!"
            otool -L "$BINARY" | grep -E '/opt/homebrew|/usr/local/opt'
            exit 1
          fi
          echo "âœ“ Binary is portable - no Homebrew dependencies found"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: edge-runtime-darwin-${{ matrix.arch }}
          path: dist/edge-runtime-${{ inputs.version }}-darwin-${{ matrix.arch }}

  # Create release with all platform binaries
  release:
    name: Create Release
    needs: [extract-linux, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          find artifacts -type f -name 'edge-runtime-*' -exec mv {} release/ \;
          ls -la release/

      - name: Generate checksums
        working-directory: release
        run: |
          sha256sum edge-runtime-* > checksums.txt
          cat checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: edge-runtime-${{ inputs.version }}
          name: Edge Runtime ${{ inputs.version }}
          draft: false
          prerelease: false
          body: |
            Pre-built edge-runtime binaries for sblite.

            Based on [supabase/edge-runtime](https://github.com/supabase/edge-runtime) ${{ inputs.version }}.

            ## Platforms
            - `darwin-arm64` - macOS Apple Silicon (built from source)
            - `darwin-amd64` - macOS Intel (built from source)
            - `linux-arm64` - Linux ARM64 (extracted from official Docker image)
            - `linux-amd64` - Linux x86_64 (extracted from official Docker image)

            ## Verification
            Verify downloads using checksums.txt:
            ```bash
            sha256sum -c checksums.txt
            ```

            ## Source
            - Linux binaries: Extracted from `ghcr.io/supabase/edge-runtime:${{ inputs.version }}`
            - macOS binaries: Built from source without Homebrew dependencies
          files: |
            release/edge-runtime-*
            release/checksums.txt
